# OTP-auth-service

A lightweight and scalable authentication microservice built with **Go** and **Fiber**, designed to provide secure *
*OTP (One-Time Password)** based login and registration.  
The service uses **PostgreSQL** for persistent user storage and **Redis** for handling OTPs and rate-limiting.

---

## Features

- OTP-based login & registration.
- Rate limiting (max 3 OTP requests per phone within 10 minutes).
- User management (list & retrieve single user).
- JWT authentication.
- Swagger/OpenAPI documentation.
- Database migrations.
- Dockerized setup for easy deployment.

---

## Project Structure

```
├── cmd/
│   ├── main.go              # Application entry point
│   └── migrate/     
│       └── main.go          # Migration runner
│
├── internal/
│   ├── api/                 # HTTP handlers (Fiber controllers)
│   ├── middleware/          # Fiber middlewares (auth, logging, etc.)
│   ├── model/               # Domain models (structs mapped to DB tables)
│   ├── repository/          # Database layer (queries, repo interfaces)
│   ├── service/             # Business logic (OTP, user, etc.)
│   └── docs/                # Swagger docs (auto-generated by swag)
│
├── migrations/              # SQL migration files
│   ├── 0001_create_users_table.up.sql
│   └── 0001_create_users_table.down.sql
│
├── pkg/
│   ├── config/              # App configuration loader (env, flags, etc.)
│   └── utils/               # Helper functions (hashing, otp generator, etc.)
│
├── Dockerfile
├── docker-compose.yml
├── .gitignore
├── go.mod
├── .env.example
└── README.md

```

---

## Environment Variables

Copy `example.env` to `.env` and set values:

```env
POSTGRES_DSN=postgres://user:password@localhost:5432/otp_auth_service?sslmode=disable
REDIS_ADDR=localhost:6379
REDIS_PASSWORD=redis-password
REDIS_DB=0
JWT_SECRET=mysecret
```

---

## Running Locally

1. Prerequisites

```
Go 1.22+
PostgreSQL
Redis
swag
```

2. Install dependencies

  ``` 
go mod tidy
```

3. Run database migrations

```
   go run cmd/migrate/main.go up # apply all migrations
   go run cmd/migrate/main.go down # rollback all
   go run cmd/migrate/main.go version # show current version
   go run cmd/migrate/main.go step 2 # apply 2 steps forward
   go run cmd/migrate/main.go step -2 # rollback 2 steps
```

4. Run the service

```
   go run cmd/main.go
```

---

## Running with Docker

Make sure you have Docker and docker-compose installed.

```
docker-compose up --build
```

This will start:

#### 1. App (otp-auth-service)

#### 2. PostgreSQL

#### 3. Redis

---

## Swagger API Documentation

#### Generate Swagger files:

```
swag init -g cmd/main.go -o internal/docs
```

#### Run the server and visit:

http://localhost:8080/swagger/index.html

---

## API Endpoints

#### Request OTP

```
curl -X POST http://localhost:8080/auth/request-otp \
-H "Content-Type: application/json" \
-d '{"phone": "09105800782"}'
```

#### Verify OTP

```
curl -X POST http://localhost:8080/auth/verify-otp \
-H "Content-Type: application/json" \
-d '{"phone": "09105800782", "otp": "123456"}'
```

#### Get Users (JWT required)

```
curl -X GET http://localhost:8080/users \
-H "Authorization: Bearer <TOKEN>"
```

#### Get User by ID (JWT required)

```
curl -X GET http://localhost:8080/users/1 \
-H "Authorization: Bearer <TOKEN>"
```

---

## Database Choice

##### PostgreSQL: persistent storage for users (structured, relational).

##### Redis: volatile storage for OTP codes and rate-limiting (fast, TTL support).

###### This hybrid approach ensures both reliability and high performance.

---

## Example Flow

1. Client calls /auth/request-otp with phone number.
2. OTP is generated, stored in Redis (expires after 2 minutes), and printed in server logs.
3. Client submits /auth/verify-otp with phone and OTP.
4. If user exists → login.
5. If not → new user is registered → login.
6. Returns a JWT token.
7. Use the token to access /users endpoints.

---